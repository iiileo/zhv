name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GO_VERSION: '1.24.2'

jobs:
  build:
    name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # å®šä¹‰è¦æ„å»ºçš„ç›®æ ‡å¹³å°
        include:
          - goos: linux
            goarch: amd64
            suffix: ''
          - goos: linux
            goarch: arm64
            suffix: ''
          - goos: windows
            goarch: amd64
            suffix: '.exe'
          - goos: darwin
            goarch: amd64
            suffix: ''
          - goos: darwin
            goarch: arm64
            suffix: ''
          - goos: freebsd
            goarch: amd64
            suffix: ''
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ç¼“å­˜ Go æ¨¡å—
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ä¸‹è½½ä¾èµ–
      run: go mod download

    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION=${{ github.ref_name }}
        else
          VERSION=$(git describe --tags --always --dirty)
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

    - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        # è®¾ç½®æ„å»ºæ ‡å¿—ï¼ŒåµŒå…¥ç‰ˆæœ¬ä¿¡æ¯
        LDFLAGS="-s -w"
        LDFLAGS="$LDFLAGS -X 'main.Version=${{ steps.version.outputs.version }}'"
        LDFLAGS="$LDFLAGS -X 'main.BuildTime=${{ steps.version.outputs.build_time }}'"
        LDFLAGS="$LDFLAGS -X 'main.GitCommit=${{ steps.version.outputs.short_sha }}'"
        
        # æ„å»º
        OUTPUT_NAME="zhv-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}"
        go build -ldflags="$LDFLAGS" -o "$OUTPUT_NAME" ./
        
        # å¦‚æœæ˜¯ Unix ç³»ç»Ÿï¼Œè®¾ç½®æ‰§è¡Œæƒé™
        if [ "${{ matrix.goos }}" != "windows" ]; then
          chmod +x "$OUTPUT_NAME"
        fi
        
        # åˆ›å»ºå‹ç¼©åŒ…
        if [ "${{ matrix.goos }}" == "windows" ]; then
          zip "$OUTPUT_NAME.zip" "$OUTPUT_NAME" README.md
        else
          tar -czf "$OUTPUT_NAME.tar.gz" "$OUTPUT_NAME" README.md
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: zhv-${{ matrix.goos }}-${{ matrix.goarch }}
        path: |
          zhv-${{ matrix.goos }}-${{ matrix.goarch }}*
        retention-days: 30

  release:
    name: åˆ›å»º Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: ./artifacts

    - name: æ•´ç†æ–‡ä»¶
      run: |
        mkdir -p ./release
        find ./artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} ./release/ \;
        ls -la ./release/

    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        # è·å–å½“å‰æ ‡ç­¾å’Œä¸Šä¸€ä¸ªæ ‡ç­¾
        CURRENT_TAG=${{ github.ref_name }}
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "")
        
        echo "current_tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "## ğŸš€ æ›´æ–°å†…å®¹" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**å®Œæ•´å˜æ›´**: [$PREVIOUS_TAG...$CURRENT_TAG](https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...$CURRENT_TAG)" >> CHANGELOG.md
        else
          echo "## ğŸ‰ é¦–æ¬¡å‘å¸ƒ" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "è¿™æ˜¯ ZHV (ä¸­æ–‡å˜é‡åæ¨èå·¥å…·) çš„é¦–æ¬¡å‘å¸ƒï¼" >> CHANGELOG.md
        fi
        
        echo "" >> CHANGELOG.md
        echo "## ğŸ“¦ ä¸‹è½½è¯´æ˜" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„æ–‡ä»¶ä¸‹è½½ï¼š" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "| æ“ä½œç³»ç»Ÿ | æ¶æ„ | æ–‡ä»¶å |" >> CHANGELOG.md
        echo "|---------|------|--------|" >> CHANGELOG.md
        echo "| Linux | x86_64 | \`zhv-linux-amd64.tar.gz\` |" >> CHANGELOG.md
        echo "| Linux | ARM64 | \`zhv-linux-arm64.tar.gz\` |" >> CHANGELOG.md
        echo "| macOS | x86_64 | \`zhv-darwin-amd64.tar.gz\` |" >> CHANGELOG.md
        echo "| macOS | ARM64 (M1/M2) | \`zhv-darwin-arm64.tar.gz\` |" >> CHANGELOG.md
        echo "| Windows | x86_64 | \`zhv-windows-amd64.zip\` |" >> CHANGELOG.md
        echo "| FreeBSD | x86_64 | \`zhv-freebsd-amd64.tar.gz\` |" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ›  å®‰è£…æ–¹æ³•" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Linux/macOS" >> CHANGELOG.md
        echo "\`\`\`bash" >> CHANGELOG.md
        echo "# ä¸‹è½½å¯¹åº”æ–‡ä»¶å¹¶è§£å‹" >> CHANGELOG.md
        echo "tar -xzf zhv-linux-amd64.tar.gz" >> CHANGELOG.md
        echo "# ç§»åŠ¨åˆ° PATH ç›®å½•" >> CHANGELOG.md
        echo "sudo mv zhv-linux-amd64 /usr/local/bin/zhv" >> CHANGELOG.md
        echo "# éªŒè¯å®‰è£…" >> CHANGELOG.md
        echo "zhv --help" >> CHANGELOG.md
        echo "\`\`\`" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Windows" >> CHANGELOG.md
        echo "1. ä¸‹è½½ \`zhv-windows-amd64.zip\`" >> CHANGELOG.md
        echo "2. è§£å‹åˆ°ä»»æ„ç›®å½•" >> CHANGELOG.md
        echo "3. å°†è§£å‹ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿ PATH ç¯å¢ƒå˜é‡" >> CHANGELOG.md
        echo "4. åœ¨å‘½ä»¤æç¤ºç¬¦ä¸­è¿è¡Œ \`zhv --help\` éªŒè¯å®‰è£…" >> CHANGELOG.md

    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Release ${{ steps.changelog.outputs.current_tag }}"
        body_path: CHANGELOG.md
        files: ./release/*
        draft: false
        prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ›´æ–°æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾
      run: |
        # å¦‚æœä¸æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œæ›´æ–° latest æ ‡ç­¾
        if [[ ! "${{ github.ref_name }}" =~ (rc|beta|alpha) ]]; then
          git tag -f latest
          git push -f origin latest
        fi
